name: Validate Framework Integrity
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate-no-user-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for user project files in framework repository
        run: |
          set -e

          echo "::group::Configuration"
          echo "Checking for user project files in framework repository..."

          # AGGIUNGI ECCEZIONI per i file del workflow stesso
          FORBIDDEN_PATTERNS=(
            "^src/"
            "^scripts/"
            "^dist/"
            "^build/"
            "^cmake/db_backend.cmake$"
            "^cmake/type_code.cmake$"
            "^cmake/app.cmake$"
            "^cmake/app_debug.cmake$"
            "^cmake/project_type.cmake$"
            "^cmake/binding_language.cmake$"
            "\.so$"
            "\.ini$"
            "\.deb$"
            "\.swp$"
            "\.pro\.user"
            "CMakeLists\.txt\.user"
            "^default\.profraw$"
            "^todo\.txt$"
            "^docs/internal/"
          )

          # ESCLUDI i file di GitHub Actions
          EXCLUDED_PATTERNS=(
            "^\.github/workflows/"
            "^\.gitignore$"
            "^README\.md$"
            "^docs/assets/"
          )
          echo "::endgroup::"

          # Get changed files
          echo "::group::Detecting changed files"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          else
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No files changed in this event"
            echo "::endgroup::"
            echo "::notice::✅ No files to validate"
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES" | sed 's/^/  - /'
          echo "::endgroup::"

          # Check for violations
          echo "::group::Validating files"
          VIOLATIONS=()

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # Skip excluded files (workflow files, docs, etc.)
            skip_file=false
            for exclude_pattern in "${EXCLUDED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$exclude_pattern"; then
                skip_file=true
                break
              fi
            done

            if [ "$skip_file" = true ]; then
              echo "✅ Allowed: $file"
              continue
            fi

            # Check for forbidden patterns
            for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                VIOLATIONS+=("$file")
                echo "⚠️  Matched forbidden pattern '$pattern': $file"
                break
              fi
            done
          done <<< "$CHANGED_FILES"
          echo "::endgroup::"

          # Report results
          if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            echo "::error::Found ${#VIOLATIONS[@]} user project file(s) in framework repository"
            for violation in "${VIOLATIONS[@]}"; do
              echo "::error file=$violation::User project file should not be in framework repository"
            done
            exit 1
          else
            echo "✅ SUCCESS: No user project files found in framework repository"
          fi
